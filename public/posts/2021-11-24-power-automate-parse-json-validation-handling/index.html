<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Power Automate: Handling JSON schema validation with Parse JSON - johnokeeffe</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Introduction Had a scenario recently when working on a project where I needed to check some required columns from a staging excel file before it was inserted into a master excel file. Now in this case it only was a small subset of the overall columns in the excel were actually needed for the process. But I didn&rsquo;t want the whole process to fall over if only one row was missing so I used the some scopes, parse JSON and JSON schema magic to build the below solution to get around it." />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Power Automate: Handling JSON schema validation with Parse JSON" />
<meta property="og:description" content="Introduction Had a scenario recently when working on a project where I needed to check some required columns from a staging excel file before it was inserted into a master excel file. Now in this case it only was a small subset of the overall columns in the excel were actually needed for the process. But I didn&rsquo;t want the whole process to fall over if only one row was missing so I used the some scopes, parse JSON and JSON schema magic to build the below solution to get around it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://johnokeeffe.ie/posts/2021-11-24-power-automate-parse-json-validation-handling/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-01T18:09:34+01:00" />
<meta property="article:modified_time" content="2021-11-01T18:09:34+01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Power Automate: Handling JSON schema validation with Parse JSON"/>
<meta name="twitter:description" content="Introduction Had a scenario recently when working on a project where I needed to check some required columns from a staging excel file before it was inserted into a master excel file. Now in this case it only was a small subset of the overall columns in the excel were actually needed for the process. But I didn&rsquo;t want the whole process to fall over if only one row was missing so I used the some scopes, parse JSON and JSON schema magic to build the below solution to get around it."/>

	
        <link href="http://johnokeeffe.ie/css/fonts.7fa06c2792c8589768ffcdaf014e4bfc7f2ccbfba059f8e87131158970c23ed3.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://johnokeeffe.ie/css/main.58ed1f9f233a108ca431c43f4e703a839ded6628733e05a9ae6288037e2ab711.css" />
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://johnokeeffe.ie/">johnokeeffe</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Power Automate: Handling JSON schema validation with Parse JSON</h1>
			<div class="meta">Posted on Nov 1, 2021</div>
		</div>
		

		<section class="body">
			<h1 id="introduction">Introduction</h1>
<p>Had a scenario recently when working on a project where I needed to check some required columns from a staging excel file before it was inserted into a master excel file. Now in this case it only was a small subset of the overall columns in the excel were actually needed for the process. But I didn&rsquo;t want the whole process to fall over if only one row was missing so I used the some scopes, parse JSON and JSON schema magic to build the below solution to get around it.</p>
<h1 id="walk-through">Walk-through</h1>
<h2 id="scenario">Scenario</h2>
<p>In the below fake scenario we receive car owner data in an excel table. We need to take this data and insert the rows in a master excel for analysis. We&rsquo;re really only looking for the owner personal data and the car vehicle identification
number (vin) as we can lookup the rest of the data from the vin. But if this vin is missing then this data isn&rsquo;t as useful to us as we can&rsquo;t guarantee they will also provide there car details.</p>
<h2 id="sample-data">Sample Data</h2>
<table>
<thead>
<tr>
<th>id</th>
<th>first_name</th>
<th>last_name</th>
<th>email</th>
<th>car_make</th>
<th>car_model</th>
<th>car_model_year</th>
<th>car_vin</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Chrisse</td>
<td>Marieton</td>
<td><a href="mailto:cmarieton0@umn.edu">cmarieton0@umn.edu</a></td>
<td></td>
<td></td>
<td></td>
<td>2G61L5S37E9694881</td>
</tr>
<tr>
<td>2</td>
<td>Dion</td>
<td>Frenchum</td>
<td><a href="mailto:dfrenchum1@nifty.com">dfrenchum1@nifty.com</a></td>
<td></td>
<td></td>
<td></td>
<td>NM0AE8F74E1334359</td>
</tr>
<tr>
<td>3</td>
<td>Brockie</td>
<td>Bushaway</td>
<td><a href="mailto:bbushaway2@google.co.uk">bbushaway2@google.co.uk</a></td>
<td></td>
<td></td>
<td></td>
<td>WBAUN1C55DV305824</td>
</tr>
<tr>
<td>4</td>
<td>Janie</td>
<td>Iacomelli</td>
<td><a href="mailto:jiacomelli3@uiuc.edu">jiacomelli3@uiuc.edu</a></td>
<td></td>
<td></td>
<td></td>
<td>WA1AGAFE7CD051379</td>
</tr>
<tr>
<td>5</td>
<td>Cassie</td>
<td>Housby</td>
<td><a href="mailto:chousby4@icq.com">chousby4@icq.com</a></td>
<td>Mitsubishi</td>
<td>Lancer Evolution</td>
<td>2004</td>
<td></td>
</tr>
</tbody>
</table>
<p>Sample Data Schema <a href="https://www.mockaroo.com/1591bbc0">Mockaroo Link</a></p>
<h2 id="flow-structure-setup">Flow Structure Setup</h2>
<p>To get started I just created a basic flow structure:</p>
<ul>
<li>Variable outputData is an array and we will use this later on as we append data to it</li>
<li>Variable outputAction is going to be use to output the action that was taken ie. <em>&ldquo;inserted into master table&rdquo; or &ldquo;error missing column data&rdquo;</em></li>
<li>List rows present in the excel table (see above for schema and sample data)</li>
</ul>
<p>I like to use scopes to help with error handling and logical design of the flows. I won&rsquo;t be discussing scope error handling in this blog but here is a great resource to read over to get you started <a href="https://www.portiva.nl/portiblog/advanced-error-handling-in-power-automate">Advanced error handling in Power Automate</a></p>
<p><img src="https://raw.githubusercontent.com/john-o-keeffe/BlogResources/main/power-automate-handling-json-schema-validation-with-parse-json/pa-setup-01.png" alt="Power Automate setup flow"></p>
<h2 id="flow-json-schema-validation-setup">Flow JSON Schema Validation Setup</h2>
<p>In this step I just create a loop to run through each row returned from the <em>list rows present in a table</em> action from above. Now we need to generate the schema for the parse json easiest way to do this is to just run the flow once. Now what we need to do is take this schema and add some constraints too it. Now in the below example all the data types are strings but this can work with other data types. See the <a href="https://json-schema.org/understanding-json-schema/index.html">JSON Schema Docs</a></p>
<p>Below you can see I have added the <a href="https://json-schema.org/understanding-json-schema/reference/string.html#id5">minLength</a> constraint to some of the objects. This means JSON is looking for each of the objects to have at least one string character present otherwise it will create a validation error. This will be the error we will read from later on. Now just create two more scopes one for the &ldquo;Happy path&rdquo; (Success) and the &ldquo;Unhappy Path&rdquo; (Error). Setup the &ldquo;Unhappy path&rdquo; to only run on <strong>has failed</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;car_vin&#34;</span>: {
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">&#34;minLength&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;@@odata.etag&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;ItemInternalId&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;id&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;minLength&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;first_name&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;minLength&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;last_name&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;minLength&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;email&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;minLength&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;car_make&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;car_model&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;car_model_year&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;car_vin&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;minLength&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="https://raw.githubusercontent.com/john-o-keeffe/BlogResources/main/power-automate-handling-json-schema-validation-with-parse-json/pa-main-scope-loop-parse.png" alt="Power Automate main scope setup with parse json"></p>
<h2 id="unhappy-path-important-step">Unhappy Path (Important Step)</h2>
<p>This is the important step and a key to the whole flow. Setup any action in this case im using a compose to make it clearer but setup an expression like the one below that will take the error output from the Parse JSON.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>  outputs(&#39;Parse_JSON&#39;)?[&#39;errors&#39;]
</span></span></code></pre></div><p>The error output will only appear when the validation has failed otherwise it just displays the body like normal. It outputs an array as seen in the below example. The key objects to look at the <strong>Path</strong>, <strong>errorType</strong> and <strong>message</strong>. If you have more complex schemas some more of this information will become useful to you when handling errors for me in this case I only need two.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;String &#39;&#39; is less than minimum length of 1.&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;lineNumber&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;linePosition&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;car_vin&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;schemaId&#34;</span>: <span style="color:#e6db74">&#34;#/properties/car_vin&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;errorType&#34;</span>: <span style="color:#e6db74">&#34;minLength&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;childErrors&#34;</span>: []
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>Now that I have an array with the errors im going to create another loop, to go though these errors set my <em>outputAction</em> variable with a custom message. This will then be append to the <em>outputData</em> array which will be used later on for a emailed report.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>  items(&#39;Apply_to_each_error&#39;)?[&#39;path&#39;]
</span></span></code></pre></div><p><img src="https://raw.githubusercontent.com/john-o-keeffe/BlogResources/main/power-automate-handling-json-schema-validation-with-parse-json/pa-unhappy-path.png" alt="Power Automate Unhappy Path"></p>
<h2 id="happy-path">Happy Path</h2>
<p>The happy path in this case is pretty simple and is where you would put the insert into excel table action. In this case I am just setting the <em>outputAction</em> variable again with a custom message to say the insert was a success. Then just appending this to the array which will be used next.</p>
<p><img src="https://raw.githubusercontent.com/john-o-keeffe/BlogResources/main/power-automate-handling-json-schema-validation-with-parse-json/pa-happy-path.png" alt="Power Automate Happy Path"></p>
<h2 id="output">Output</h2>
<p>Last but not least the output of all that data we just logged into the <em>outputData</em> variable. Because the variable I had created at the start is an array this will allow us to use the <em>create html table</em> action easily, to create a html table we can use in Email, Teams etc&hellip;</p>
<p><img src="https://raw.githubusercontent.com/john-o-keeffe/BlogResources/main/power-automate-handling-json-schema-validation-with-parse-json/pa-output.png" alt="Power Automate Output"></p>
<p><img src="https://raw.githubusercontent.com/john-o-keeffe/BlogResources/main/power-automate-handling-json-schema-validation-with-parse-json/pa-email-report.png" alt="Power Automate Output"></p>
<h2 id="conclusion">Conclusion</h2>
<p>This isn&rsquo;t the only approach to error handling in power automate. But I found in this case it was useful way of solving my issue and also learnt something new in the process.</p>

		</section>

		<div class="post-tags">
			
			
			
		</div>
	</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2022  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


</div>
    </body>
</html>
